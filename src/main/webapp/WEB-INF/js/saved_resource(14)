M.add("mt-date",function(a){var b=a.Lang.isDate,c=a.Lang.isArray;a.namespace("mt.date"),a.mt.date={getTimeReduction:function(a,c,d){return b(a)&&b(c)?(d&&(a=new Date(a.getFullYear(),a.getMonth(),a.getDate()),c=new Date(c.getFullYear(),c.getMonth(),c.getDate())),c.getTime()-a.getTime()):null},isInRegions:function(a,c,d,e){if(!b(a)||!b(c)||!b(d))return!1;var f=this.getTimeReduction(c,a),g=this.getTimeReduction(a,d);return e?f>0&&g>0:f>=0&&g>=0},equalTime:function(a,b,c){return c?a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate():a.getTime()===a.getTime()},formatDate:function(b,c){if(!a.Lang.isDate(b))return null;var d=b.getFullYear(),e=b.getMonth(),f=b.getDate(),g=e+1,h=f;return 10>g&&(g="0"+g),10>f&&(h="0"+h),c?[d,g,h].join(c):d+"年"+g+"月"+h+"日"},formatDateByString:function(a,b){if(a){var c={"M+":a.getMonth()+1,"d+":a.getDate(),"h+":a.getHours(),"m+":a.getMinutes(),"s+":a.getSeconds(),"q+":Math.floor((a.getMonth()+3)/3),S:a.getMilliseconds()};/(y+)/.test(b)&&(b=b.replace(RegExp.$1,(a.getFullYear()+"").substr(4-RegExp.$1.length)));for(var d in c)new RegExp("("+d+")").test(b)&&(b=b.replace(RegExp.$1,1===RegExp.$1.length?c[d]:("00"+c[d]).substr((""+c[d]).length)));return b}},isPeriodsOverlap:function(b,c){if(a.Lang.isArray(b)){c=c===!1?!1:!0;var d=this;a.Array.each(b,function(b){var c=b[0],e=b[1];a.Lang.isString(c)&&(c=d.buildDateByFormatedString(c)),a.Lang.isString(e)&&(e=d.buildDateByFormatedString(e)),b[0]=c,b[1]=e});var e=!1;return a.Array.each(b,function(a,f){for(var g=f+1;g<b.length;g++){var h=b[g],i=d.isTwoPeriodOverlap(a,h,c);if(i)return void(e=!0)}}),e}},isTwoPeriodOverlap:function(a,b,c){var d=this.getTimeReduction(a[1],b[0]),e=this.getTimeReduction(b[1],a[0]);return c?!(d>=0||e>=0):!(d>0||e>0)},compareByString:function(a,b){var c=this.buildDateByFormatedString(a),d=this.buildDateByFormatedString(b);return this.compareDate(c,d)},compareDate:function(a,b){var c=a.getTime(),d=b.getTime();return c===d?0:d>c?-1:1},buildDateByFormatedString:function(b){if(a.Lang.isString(b)){b=a.Lang.trim(b);var c=b.split(" ")[0],d=b.split(" ")[1],e=c.split("-"),f=parseInt(e[0],10),g=parseInt(e[1],10),h=parseInt(e[2],10),i=0,j=0,k=0;if(d){var l=d.split(":");i=parseInt(l[0]||0,10),j=parseInt(l[1]||0,10),k=parseInt(l[2]||0,10)}return new Date(f,g-1,h,i,j,k)}},getMaxDaysInMonth:function(a,b){b=parseInt(b,10);var c=new Date(a,b,0);return c.getDate()},fillTimeSection:function(b,c,d){c&&a.Lang.isArray(b)&&d&&(c.set("value",b[0]),d.set("value",b[1]))},_replaceOptionString2Node:function(b){for(var c=0;c<b.length;c++){var d=b[c];"string"==typeof d&&(b[c]=a.Node.create(d))}},buildDateSelect:function(b,d){var e=a.one(b);if(e){d=d||{},"undefined"==typeof d.options?d.options=[]:c(d.options)&&this._replaceOptionString2Node(d.options);var f=["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],g=d.options;"year"===d.type?d.to=d.to||(new Date).getFullYear():(d.from=d.from||1,d.to=d.to<=12?d.to:12);for(var h=d.from;h<=d.to;h++){var i="",j=h,k="";"year"===d.type?i=h:(i=f[h-1],d.fillZero&&10>h&&(j="0"+h)),d.selectVal&&d.selectVal.toString()===j.toString()&&(k=" selected='selected'"),g.push(a.Node.create('<option value="'+j+'"'+k+">"+i+"</option>"))}e.setHTML(new a.NodeList(g).toFrag())}},calculateDay:function(a,b){var c,d,e;b=b||new Date;var f=[],g=this,h=/^([pnt]{1})(\d*)(\w+)/,i=a.match(h);if(/recentdays/.test(a)&&(e=a.split("-")[1],i=[a,"p",e,"day"]),i){var j=parseInt(i[2],10)||1,k=i[1];switch(i[3].substring(0,3)){case"day":f=g._calcDay(k,j,b);break;case"wee":f=g._calcWeek(k,j,b);break;case"mon":f=g._calcMonth(k,j,b);break;case"qua":f=g._calcQuarter(k,j,b);break;case"yea":f=g._calcYear(k,j,b);break;default:"today"===i[0]&&(c=d=b.getTime())}}if(f.length>0&&(c=f[0],d=f[1]),c>d){var l=c;c=d,d=l}return d=this.formatDate(new Date(d),"-"),c=this.formatDate(new Date(c),"-"),[c,d]},_calcDay:function(a,b,c){var d,e,f=1;switch(a){case"t":f=0;break;case"p":f=-1}return c.setDate(c.getDate()+b*f),d=c.getTime(),c.setDate(c.getDate()-b*f),e=c.getTime(),[d,e]},_calcWeek:function(a,b,c){var d,e,f=1,g=1,h=1,i=0===c.getDay()?7:c.getDay();switch(a){case"t":f=0;break;case"p":f=-1;break;case"n":h=7,g=-1}return c.setDate(c.getDate()+7*b*f-i+h),d=c.getTime(),c.setDate(c.getDate()-7*(b-1)*f+6*g),e=c.getTime(),[d,e]},_calcMonth:function(a,b,c){var d,e,f=1,g=1,h=0;switch(a){case"t":f=0,h=1;break;case"p":f=-1;break;case"n":b+=1,g=0,h=2}return c.setMonth(c.getMonth()+b*f),c.setDate(g),d=c.getTime(),c.setMonth(c.getMonth()-b*f+h),c.setDate(Number(!g)),e=c.getTime(),[d,e]},_calcQuarter:function(a,b,c){var d,e,f,g=1,h=parseInt(c.getMonth()/3,10)+1,i=3*h-2,j=1;switch(a){case"t":g=-1,d=3;break;case"p":g=-1,i-=3*b,d=3*b;break;case"n":i+=3*(b+1),j=0,d=-3*b+1}return c.setMonth(i-1),c.setDate(j),e=c.getTime(),c.setMonth(c.getMonth()+d),c.setDate(Number(!j)),f=c.getTime(),[e,f]},_calcYear:function(a,b,c){var d,e,f=1,g=0,h=1,i=11,j=31;switch(a){case"t":f=0;break;case"p":f=-1;break;case"n":g=i,h=j,i=0,j=1}return c.setFullYear(c.getFullYear()+f*b),c.setMonth(g),c.setDate(h),d=c.getTime(),c.setFullYear(c.getFullYear()-f*b+f),c.setMonth(i),c.setDate(j),e=c.getTime(),[d,e]}}},"1.0.0",{requires:["mt-base","node"]});
M.add("w-calendar",function(a){function b(){b.superclass.constructor.apply(this,arguments)}var c=a.mt.date,d=a.mt.util,e=a.Lang,f={dayToday:"day--today",dayHover:"day--hover",daySelected:"day--selected",daySelectable:"day--selectable",dayCurMonth:"day--cur-month",dayPrevMonth:"day--prev-month",dayNextMonth:"day--next-month",ctlPrevMonth:"calendar-control--previous",ctlNextMonth:"calendar-control--next",ctlDisabled:"calendar-control--disabled",ctlDisplay:"calendar-control--display"},g={control:'<div class="calendar-controls"><a class="calendar-control {prevMonthClass}" href="javascript:void(0);" title="{prevMonthTitle}">&lsaquo;</a><span class="calendar-control calendar-control--display">{currentMonth}</span><a class="calendar-control {nextMonthClass}" href="javascript:void(0);" title="{nextMonthTitle}">&rsaquo;</a>{extraControlMarkup}</div>',table:'<table class="calendar-table" cellspacing="0" cellpadding="0" border="0"><thead class="calendar-table__header">{header}</thead><tbody class="calendar-table__body">{body}</tbody></table>',cell:'<td class="day {dayClass}" data-day="{day}"><div class="day__wrapper"><span class="day__num">{day}</span></div></td>',cellEmpty:'<td class="day {dayClass}" data-day="{day}"><div class="day__wrapper">&nbsp;</div></td>',cellHeader:'<td class="weekday">{label}</td>'};b.NAME="Calendar",b.CSS_PREFIX="widget-calendar",b.ATTRS={container:{value:null,setter:function(b){return a.one(b)},writeOnce:!0},showPrevMonthDays:{value:!1,writeOnce:!0},showNextMonthDays:{value:!1,writeOnce:!0},extraControlMarkup:{value:"",writeOnce:!0},startOnSunday:{value:!0,writeOnce:!0},minDate:{value:null,setter:"_setMindate"},maxDate:{value:null,setter:"_setMaxdate"}},a.extend(b,a.Widget,{initializer:function(){var a=this,c=a.get("container");if(!c)throw new Error(b.NAME+": 没有设置container或container不存在");a.currentDate=new Date,a.canPrevMonth=!0,a.canNextMonth=!0,a.publish("refresh",{emitFacade:!0,defaultFn:a.refresh}),a.publish("select",{emitFacade:!0,defaultFn:a._defSelectFn}),a.render()},renderUI:function(){this.get("container").setHTML(this._generateHTML())},bindUI:function(){var a=this,b=this.get("container"),c="."+f.daySelectable,e="."+f.ctlPrevMonth,g="."+f.ctlNextMonth;b.delegate("click",function(b){var f=this,h=a.currentDate,i=h.getFullYear(),j=h.getMonth(),k=d.data(f,"day"),l=new Date(i,j,k);f.test(c)?a.fire("select",{ndTarget:f,currentDate:h,selectedDate:l}):f.test(e)?(b.preventDefault(),a.prevMonth()):f.test(g)&&(b.preventDefault(),a.nextMonth())},[e,g,c].join(","))},getSelectable:function(){var a=this,b=a.get("container");return b.all("."+f.daySelectable)},getSelected:function(){var a=this,b=a.get("container");return b.all("."+f.daySelected)},prevMonth:function(){var a=this;a.canPrevMonth&&(a.currentDate.setDate(1),a.currentDate.setMonth(a.currentDate.getMonth()-1),a.canNextMonth=!0,a.fire("refresh",{currentDate:a.currentDate}))},nextMonth:function(){var a=this;a.canNextMonth&&(a.currentDate.setDate(1),a.currentDate.setMonth(a.currentDate.getMonth()+1),a.canPrevMonth=!0,a.fire("refresh",{currentDate:a.currentDate}))},refresh:function(){var a=this,b=a.get("container");b.setHTML(a._generateHTML())},setDate:function(a){var b,c=this,d=c.currentDate,f=!0;e.isDate(a)?b=a:(b=new Date,b.setTime(Date.parse(a))),d.getFullYear()===b.getFullYear()&&d.getMonth()===b.getMonth()&&(f=!1),c.currentDate=b,f&&(c.refresh(),c.fire("refresh",{currentDate:c.currentDate}))},_defSelectFn:function(a){var b=a.ndTarget,c=f.daySelected;b.hasClass(c)?b.removeClass(c):b.addClass(c)},_setMindate:function(a){if(e.isDate(a))return a;if(e.isString(a)){var b=new Date(a);return new Date(b.getFullYear(),b.getMonth(),b.getDate())}return new Date(2010,3,4)},_setMaxdate:function(a){if(e.isDate(a))return a;if(e.isString(a)){var b=new Date(a);return new Date(b.getFullYear(),b.getMonth(),b.getDate())}return new Date(2099,12,31)},_generateHTML:function(){return this._generateCalendarControl()+this._generateCalendarTable()},_generateCalendarControl:function(){var b,c=this,d=g.control,e=c.get("minDate"),h=c.get("maxDate"),i=c.currentDate,j=i.getFullYear(),k=i.getMonth(),l=f.ctlPrevMonth,m=f.ctlNextMonth;return k<=e.getMonth()&&j<=e.getFullYear()&&(l+=" "+f.ctlDisabled,c.canPrevMonth=!1),k>=h.getMonth()&&j>=h.getFullYear()&&(m+=" "+f.ctlDisabled,c.canNextMonth=!1),b={prevMonthTitle:0===k?j-1+"年12月":j+"年"+k+"月",prevMonthClass:l,nextMonthTitle:11===k?j+1+"年1月":j+"年"+(k+2)+"月",nextMonthClass:m,extraControlMarkup:c.get("extraControlMarkup"),currentMonth:j+"年"+(k+1)+"月"},a.mix(b,f),a.Lang.sub(d,b)},_generateCalendarTable:function(){var b,c=g.table;return b={body:this._generateCalendarCells(),header:this._generateCalendarHeader()},a.Lang.sub(c,b)},_generateCalendarHeader:function(){var a=this,b=a.get("startOnSunday"),c=g.cellHeader,d=["一","二","三","四","五","六","日"],f=["<tr>"];b&&d.unshift(d.pop());for(var h=0;7>h;h++)f.push(e.sub(c,{label:d[h]}));return f.push("</tr>"),f.join("")},_generateCalendarCells:function(){var a,b,d,h,i=this,j=i.get("startOnSunday"),k=g.cell,l=g.cellEmpty,m=f.dayToday,n=f.daySelectable,o=f.dayCurMonth,p=f.dayPrevMonth,q=f.dayNextMonth,r=i.get("showPrevMonthDays"),s=i.get("showNextMonthDays"),t=i.get("minDate"),u=i.get("maxDate"),v=i.currentDate,w=v.getFullYear(),x=v.getMonth(),y=new Date(w,x,1),z=y.getDay(),A=new Date,B=y,C=0===x?11:x-1,D=c.getMaxDaysInMonth(w,C+1),E=c.getMaxDaysInMonth(w,x+1),F=E,G=[];for(a=j?z:z?z-1:6,b=(7-(a+E)%7)%7,G.push("<tr>"),d=1;a>=d;d++)G.push(e.sub(r?k:l,{dayClass:p,day:D-a+d}));for(d=1;F>=d;d++)B.setDate(d),h=[o],c.isInRegions(B,t,u)&&h.push(n),0===c.getTimeReduction(B,A,!0)&&h.push(m),G.push(e.sub(k,{dayClass:h.join(" "),day:d})),(d+a)%7===0&&F>d&&G.push("</tr><tr>");for(d=1;b>=d;d++)G.push(e.sub(s?k:l,{dayClass:q,day:d}));return G.push("</tr>"),G.join("")}}),a.mt.widget.Calendar=b},"1.0.0",{requires:["mt-base","widget","mt-date","node"]});
M.add("deal-digest-travelcalendar",function(a){var b=a.mt.util,c=a.mt.www;c.DealDigestTravelCalendar=function(){return{init:function(){function c(){n&&m&&(k.delegate("click",function(){n.show()},".J-travel-checkin"),m.after("refresh",d),m.on("select",i),n.delegate("click",function(a){n.hide()},".day--selectable"),a.one("body").on("click",function(a){var b=a.target;b===o||b.hasClass("calendar")||b.hasClass("calendar-control")||b.hasClass("arrow")||n.contains(b)||b.hasClass("time-info")||n.hide()}))}function d(a){var b=a.currentDate,c=b.getFullYear(),d=t.getRealMonth(b.getMonth());e(c,d)}function e(a,b){var c=n.all(".day--selectable");c.each(function(c){var d=t.formatNumber(c.getData("day")),e=""+a+b+d,f=u[e];if(f){var i=u[e].stock;!f.isFilter&&i>0?i>=10?g(c,f,!0):g(c,f):h(c)}else h(c)})}function f(){n=a.one("#J-travel-calendar"),n&&(m=new a.mt.widget.Calendar({container:n,startOnSunday:!0,minDate:x,maxDate:z}),e(A.getFullYear(),t.getRealMonth(A.getMonth())))}function g(a,b,c){var d=c?"":"<p>剩"+b.stock+"</p>";d+='<p class="day__title">'+a.getData("day")+"</p>",d+='<p class="day__title"><span class="J-travel-buy-price">¥'+b.price+"</span></p>",a.addClass("day--enable").setHTML(d)}function h(a){a.removeClass("day--enable").removeClass("day--selectable").addClass("day--full").addClass("day--unavailable").setHTML('<p class="day__title">'+a.getData("day")+"</p><p>不可约</p>")}function i(b){var c=b.selectedDate.getFullYear(),d=b.selectedDate.getMonth()+1,e=t.formatNumber(d),f=b.selectedDate.getDate(),g=t.formatNumber(f),h=""+c+e+g,i=a.one(".J-cart-quantity"),j="";i&&(j=a.one(".J-cart-quantity").get("value"));var k="/deal/buy/"+D+"?q="+j+"&selectDate="+h,l=t.formatDate(h);o.set("value",l),p.setHTML(t.getWeekDay(l)),window.location.href=k}function j(a){a=a.toString();var b=a.substring(0,4),c=a.substring(4,6),d=a.substring(6,8);return b+"-"+c+"-"+d}var k=a.one("#J-travel-form");if(k){var l=a.one("#J-travel-calendar");if(l){var m,n,o=a.one("#J-start-date"),p=a.one(".J-checkin-info"),q=this,r=k.getData("params"),s=b.decodeJSON(r),t=q.helper,u=s.priceCalendarArr,v=s.startDate,w=s.minValidDate?s.minValidDate:v,x=j(v),y=j(w),z=j(s.endDate),A=new Date(x),B=l.getData("params"),C=b.decodeJSON(B),D=C.dealid;o.set("value",y);var E=t.getWeekDay(y);p.setHTML(E),f(),c()}}},helper:{formatDate:function(a){var b=a.substring(0,4),c=a.substring(4,6),d=a.substring(6,8);return b+"-"+c+"-"+d},getRealMonth:function(a){return("0"+(a+1)).slice(-2)},formatNumber:function(a){return 10>a?"0"+a:a},getWeekDay:function(a){var b=new Date(a),c=new Date,d=["周日","周一","周二","周三","周四","周五","周六"],e=(c.getTime()-b.getTime())/864e5;return e>=0&&1>e?"今天":d[b.getDay()]}}}}(),a.mt.ComponentHub.attach("deal-digest-travelcalendar",function(){c.DealDigestTravelCalendar.init()})},"1.0.0",{requires:["www-base","www-dialog","w-calendar"]});
M.add("www-pagenav",function(a){function b(b,c,d){d=d||{},this._ndPageNav=a.one(b),this.bindEvent(),this.gaBase=d.gaBase,this.callBack=c}var c='<li class="{class}"><a href="javascript:void(0);"{gaevent} hidefocus="true" data-index="{index}">{linkText}{tri}</a></li>';b.prototype={render:function(b){var c=[],d={hasHeadEnd:!0,currentPage:1,minPage:1,maxPage:99,extraNum:2,showNavCount:0,gaBase:""},e=this._ndPageNav;return this.config=a.merge(d,b),d=this.config,d.currentPage<d.minPage||d.currentPage>d.maxPage||d.minPage===d.maxPage?(e.setHTML(""),void e.hide()):(this.getPrePage(c),this.getInnerPage(c),this.getNextPage(c),e.show(),void e.setHTML(c.join("")))},getInnerPage:function(b){function d(d){k.minPage<=d&&k.maxPage>=d&&b.push(d===k.currentPage?'<li class="current"><span data-index="'+d+'">'+d+"</span></li>":a.Lang.sub(c,{gaevent:h.getGA(d),index:d,tri:"","class":"page-link",linkText:d}))}var e,f,g,h=this,i=this._offset||0,j=i+1,k=h.config,l=0;if(k.showNavCount>0)for(f=parseInt(k.showNavCount/2,10),k.showNavCount>=k.maxPage?j=1:k.showNavCount-k.currentPage+i>=f&&k.currentPage!==i+1?j=i+1:(e=k.maxPage-k.currentPage<f?k.maxPage-k.currentPage:f,g=k.showNavCount-(k.currentPage-i)-e,j-=g,i-=g,j=j>0?j:1,i=i>0?i:0,h._offset=i);l<k.showNavCount;)d(j),l++,j++;else for(l=2*k.extraNum+1,j=k.currentPage-k.extraNum;l>0;)d(j),l--,j++},getPrePage:function(b){var d=this.config;d.currentPage===d.minPage?(d.hasHeadEnd&&b.push('<li class="first-page"><span>首页</span></li>'),b.push('<li class="previous"><span><i class="tri disable"></i>上一页</span></li>')):(d.hasHeadEnd&&b.push(a.Lang.sub(c,{gaevent:this.getGA("firstpage"),index:1,tri:"","class":"first-page",linkText:"首页"})),b.push(a.Lang.sub(c,{gaevent:this.getGA("prepage"),index:d.currentPage-1,"class":"previous",tri:'<i class="tri"></i>',linkText:"上一页"})))},getNextPage:function(b){var d=this.config;d.currentPage===d.maxPage?(b.push('<li class="next"><span>下一页<i class="tri disable"></i></span></li>'),d.hasHeadEnd&&b.push('<li class="last-page"><span>尾页</span></li>')):(b.push(a.Lang.sub(c,{gaevent:this.getGA("nextpage"),index:d.currentPage+1,"class":"next",tri:'<i class="tri"></i>',linkText:"下一页"})),d.hasHeadEnd&&b.push(a.Lang.sub(c,{gaevent:this.getGA("lastpage"),index:d.maxPage,tri:"","class":"last-page",linkText:"尾页"})))},getGA:function(a){var b=this.config.gaBase;return b?' gaevent="'+b+a+'"':""},bindEvent:function(){var a=this;this._ndPageNav.delegate("click",function(b){var c=parseInt(b.currentTarget.getAttribute("data-index"),10);a.callBack?a.callBack({index:c}):a.render({currentPage:c,maxPage:a.maxPage})},"a[data-index]")}},b.prototype.constructor=b,a.mt.www.PageNav=b},"1.0.0",{requires:["www-base"]});
M.add("review-list",function(a){function b(a){return"."+a}var c=a.io,d=a.mt.util,e=function(){this._attrs={tab:"all",withContent:!0,sortType:"default",label:null}};e.prototype={constructor:e,set:function(a,b){var c=this.get(a);c!==b&&(this._set(a,b),this._updateRestAttrs(a,b),this.fire("attrchange"))},get:function(a){return this._attrs[a]},_set:function(a,b){this._attrs[a]=b},_updateRestAttrs:function(a,b){switch(a){case"label":return void this._afterLabelChange(b);case"withContent":return void this._afterWithContentChange(b);case"tab":this._afterTabChange(b)}},_afterLabelChange:function(a){a&&(this._set("tab",null),this._set("withContent",!0))},_afterWithContentChange:function(a){var b=this.get("tab");a||(("withpic"===b||null===b)&&this._set("tab","all"),this._set("label",null))},_afterTabChange:function(a){null!==a&&("withpic"===a&&this._set("withContent",!0),this._set("label",null))}},a.augment(e,a.EventTarget);var f=function(b){var c={rateFilter:null,placeholder:null,action:""};this.config=a.merge(c,b),this.ndLabelsWrapper=null};f.CLASS_LABELS_WRAPPER="J-labels-wrapper",f.prototype={constructor:f,init:function(){var a=this;c(this.config.action,{method:"GET",on:{success:function(b,c){var e,f,g,h,i=d.getEvalRes(c);e=i.data,e&&(f=e.length,f&&(g=i.trackData,g&&(h=g.pm),window._mbq("trackModuleview",g),a._render(e,f,h),a._bindEvents()))}}})},_render:function(b,c,d){var e,g,h,i,j,k=d?'data-mod="'+d+'"':"",l='<div class="rate-labels-wrapper '+f.CLASS_LABELS_WRAPPER+'" '+k+'><p class="title">大家都在说：</p><div class="labels">',m="content/detail/reviews/cloud/good",n="content/detail/reviews/cloud/bad",o=1,p=1,q=this.config.placeholder;for(e=0;c>e;e++)h="rate-label",g=b[e],g.isPositive?(h+=" rate-label--positive",j=m+o,o++):(j=n+p,p++),l+='<a href="#" class="'+h+'" data-label="'+g.label+'" hidefocus="true" gaevent="'+j+'">'+g.label+"("+g.count+")</a>";l+="</div></div>",i=this.ndLabelsWrapper=a.Node.create(l),q&&q.insert(i,"after")},_bindEvents:function(){var b=this.ndLabelsWrapper,c=this.config.rateFilter;c.on("attrchange",a.bind(this._updateView,this)),b.delegate("click",function(a){a.preventDefault();var b=a.target,d=b.getData("label");d!==c.get("label")&&c.set("label",d)},"a")},_updateView:function(){var a=this.ndLabelsWrapper,b=this.config.rateFilter,c=b.get("label");if(a){var d,e="rate-label--active",f="rate-label--positive--active",g="rate-label--positive",h=a.one("."+e+", ."+f);h&&(h.removeClass(e),h.removeClass(f)),c&&(d=a.one('[data-label="'+c+'"]'),d.addClass(d.hasClass(g)?f:e))}}};var g=function(c){var d,h={pageLimit:10,hasLabelCloud:!1,labelCloudAction:null,labelPlaceholder:"#J-overview",isDeal:!0,dealId:0,poiId:"all",cityId:0,showPoiTitle:"0",ndWrapper:a.one(b(g.CLASS_RATE_LIST_WRAPPER)),ndFilter:a.one(b(g.CLASS_FILTER_WRAPPER)),ndWithContent:a.one(b(g.CLASS_WITH_CONTENT_CHECKBOX)),ndSortSelect:a.one(b(g.CLASS_SORT_TYPE_SELECT)),ndPageNav:a.one(b(g.CLASS_PAGE_NAV))};return this.config=c=a.merge(h,c),c.isDeal&&"all"===c.dealId||!c.isDeal&&"all"===c.poiId?null:(c.rateFilter=new e,d=a.one(this.config.labelPlaceholder),c.hasLabelCloud&&"undefined"!=typeof d&&(c.labelCloud=new f({rateFilter:c.rateFilter,placeholder:d,action:c.labelCloudAction})),void this.init())};g.CLASS_RATE_LIST_WRAPPER="J-rate-wrapper",g.CLASS_RATE_LIST="J-rate-list",g.CLASS_RATE_LIST_LOADING="J-list-loading",g.CLASS_FILTER_WRAPPER="J-rate-filter",g.CLASS_WITH_CONTENT_CHECKBOX="J-rate-withcontent",g.CLASS_PAGE_NAV="J-rate-paginator",g.CLASS_SORT_TYPE_SELECT="J-filter-ordertype",g.CLASS_TAB_LINK="J-filter-link",g.TPL_LOADING='<div class="loading-surround--large ratelist-content__loading J-list-loading"></div>',g._cachedRatelist={},g.prototype={constructor:g,init:function(){var c,d=this.config,e=d.labelCloud,f=this.config.ndWrapper;this._ndLoading=a.Node.create(g.TPL_LOADING),this._ndRatelist=f.one(b(g.CLASS_RATE_LIST)),f.insert(this._ndLoading,this._ndRatelist),this._ndLoading.hide(),e&&e.init(),this._bindFilterEvents(),g.bindEvents(this.config.ndWrapper),this._ndRatelist.getData("fetchfirstpage")?this._refreshRatelist():(c=parseInt(this.config.ndPageNav.getData("total"),10),this._renderPageNav(c,0),g.renderRatePicList(this.config.ndWrapper))},_refreshRatelist:function(b){var c,e,f=this.config,g=this,h=f.rateFilter,i=h.get("tab"),j=h.get("label"),k="/deal/feedbacklist/{dealId}/{poiId}/{filter}/{withContent}/{sortType}/{cityId}",l="/deal/{isPoi}feedbacklistbylabel/{id}/{label}/{sortType}",m={dealId:f.dealId,cityId:f.cityId,id:f.dealId,poiId:f.poiId,filter:"all",withContent:0,sortType:h.get("sortType"),label:"",isPoi:""},n={limit:f.pageLimit,showpoititle:f.showPoiTitle,offset:b||0};"withpic"===i?n.withpic=1:i&&(m.filter=i),j?(e=l,m.label=encodeURI(j),"all"!==f.poiId&&(m.isPoi="poi",m.id=f.poiId)):e=k,c=a.Lang.sub(e,m),c=c+"?"+d.toPostData(n),this._fetchReviewListData(c,function(b){var c=b.data;b.status&&(g._renderRateList(c.ratelistHtml),g._renderPageNav(c.total,n.offset),a.Global.fire("PageHeight:change"))})},_fetchReviewListData:function(a,b){var e,f,h,i=g._cachedRatelist[a];return i?void b(i):(e=this.config.ndWrapper,f=this._ndLoading,h=this._ndRatelist,f.show(),h.hide(),void c(a,{method:"GET",on:{success:function(c,e){f.hide(),h.show();var i=d.getEvalRes(e);g._cachedRatelist[a]=i,b(i)}}}))},_renderPageNav:function(b,c){var d=new a.mt.www.PageNav(this.config.ndPageNav);d.render({currentPage:Math.ceil((parseInt(c,10)+1)/this.config.pageLimit),maxPage:Math.ceil(b/this.config.pageLimit),gaBase:"content/detail/reviews/prepage"})},_renderRateList:function(a){var b=this._ndRatelist;b.setHTML(a),g.renderRatePicList(b)},_bindFilterEvents:function(){var a=this.config.ndWrapper,c=this,e=this.config.rateFilter,h=this.config.ndFilter,i=this.config.ndSortSelect,j=this.config.ndWithContent;e.on("attrchange",function(){c._updateFilterView(),c._refreshRatelist()}),j.on("change",function(a){var b,c=a.target;b=c.get("checked"),e.set("withContent",b)}),h.delegate("click",function(a){a.preventDefault();var b=this.getData("tab"),c=e.get("tab");b!==c&&e.set("tab",b)},b(g.CLASS_TAB_LINK)),i.on("change",function(){var a=i.get("value");e.set("sortType",a)}),this.config.ndPageNav.delegate("click",function(){var e,g=this,i=1,j=a.one(b(f.CLASS_LABELS_WRAPPER)),k="";i=d.data(g,"index"),j?window.scrollTo(0,j.getY()-46):window.scrollTo(0,h.getY()-46),k=this.getAttribute("data-index"),k&&k.length<2&&(k="0"+k),window._gaq.push(["_trackEvent","InnerLink","Click","content/detail/review/page"+k]),e=(i-1)*c.config.pageLimit,c._refreshRatelist(e)},"a")},_updateFilterView:function(){this._updateFilterWithContent(),this._updateFilterTabs()},_updateFilterWithContent:function(){var a=this.config.ndWithContent,b=this.config.rateFilter,c=b.get("withContent");a.set("checked",c)},_updateFilterTabs:function(){var a=this.config,b=a.rateFilter,c=a.ndFilter,d=b.get("tab"),e="rate-filter__link--active",f=c.one("."+e),g=c.one('[data-tab="'+d+'"]');f&&f.removeClass(e),g&&g.addClass(e)}};var h={bindEvents:function(a){a.delegate("click",function(){h.agreeEvaluate(this,this.getData("feedbackId"))},".J-useful"),a.delegate("click",function(a){a.halt();var b=this.ancestor(".J-ratelist-item"),c=b.getData("rateid"),d=b.one(".J-normal-view"),e=b.one(".J-long-view");return e.getData("rendered")?(d.toggleView(),e.toggleView(),void window.scrollTo(0,b.getY()-46)):void h.getRateLongDetail(c,function(a){e.setHTML(a.comment),e.setData("rendered",!0),d.toggleView(),e.toggleView(),e.append('<p><a href="#" class="J-show-moreorless">收起</a></p>')})},".J-show-moreorless")},agreeEvaluate:function(b,e){var f,g,h,i="/deal/vote/{dealfeedbackid}",j=b.siblings(".J-agree-tips"),k={dealfeedbackid:e};g=a.Lang.sub(i,k),h=parseInt(b.getData("agreed"),10),f=c(g,{method:"POST",on:{success:function(a,c){var e=d.getEvalRes(c);0===e.status&&(h+=1,b.set("title","有"+h+"人认为这条评价有用"),b.set("data-feedbackId",h),b.setHTML('有用<span class="number">('+h+")</span>")),j.set("text",e.msg)}}})},getRateLongDetail:function(a,b){var e="/rates/longdetail/"+a;c(e,{method:"GET",on:{success:function(a,c){var e=d.getEvalRes(c);b(e)}}})},buildSingleRatePicItem:function(a){var b,c,d,e;if(!a)return"";if(e=a.length,!e)return"";for(d='<div class="pic-list J-piclist-wrapper"><div class="J-pic-thumbnails pic-thumbnails"><ul class="pic-thumbnail-list">',b=0;e>b;b++)c=a[b],d+='<li data-src="'+c.url+'"><a class="pic-thumbnail" href="#" hidefocus="true">    <img src="'+c.url.replace("/w.h/","/126.126/")+'"/></a></li>';return d+='</ul></div><div class="J-pic-preview pic-preview"></div></div>'},renderRatePicList:function(b){if(b){var c=b.all(".J-piclist-wrapper");c.isEmpty()||a.use("w-carousel",function(a){c.each(function(b){new a.mt.widget.Carousel({contentBox:b,ndCarousel:".J-pic-preview",ndIndicatorWrap:".J-pic-thumbnails",fillLastPage:!0,getCarouselSrc:function(a){return a.getData("src").replace("/w.h/","/668.500/")}}).render()})})}}};a.mix(g,h),a.namespace("mt.www.ReviewList"),a.mt.www.ReviewList=g,a.mt.ComponentHub.attach("review-list",function(c){var d=c.component.params;a.mt.ViewportTracker.onceenter(a.one(b(d.ndWrapper||g.CLASS_RATE_LIST_WRAPPER)),function(){new g(d)})})},"1.0.0",{requires:["www-base","www-pagenav","mt-viewporttracker"]});
M.add("soso-map",function(a){var b=a.io,c=a.Lang.isArray,d=a.Lang.trim,e=a.mt.util,f=a.mt.www,g=a.mt.Dialog,h=a.mt.lang;a.mt.www.Map={showBizMap:function(b,c){window.qq&&window.qq.maps?f.Map.printBizMap(b,c):M.load(function(){a.Get.js("http://map.qq.com/api/js?v=2.exp&callback=Y.mt.www.Map.callback",function(a){a||f.Map.printBizMap(b,c)})})},printBizMap:function(i,j){function k(){a.Array.each(y.get("markers"),function(a,b){a.setAnimation(x.MarkerAnimation.DROP),y.addListener(a,"click",function(){o(),z.openInfoWindow(b)})})}function l(){var b=i.shops;i.shops={},a.Object.each(b,function(a,b){a.name&&c(a.position)&&2===a.position.length&&(i.shops[b]=a)})}function m(){var b={container:w,markers:[],options:{scrollwheel:!0}};a.mix(b,i,!1,["center","zoom"]),a.Object.each(i.shops,function(a){b.markers.push({position:a.position,title:a.name})}),1!==b.markers.length||b.zoom||(b.zoom=16,b.center=b.markers[0].position),y=new a.mt.Map(b),k(),y.render(),y.get("map")&&F.on("click",function(){o()})}function n(){return i.shops?void E.each(function(a){a.delegate("click",function(a){a.preventDefault();var b=e.data(this,"id"),c=e.data(this,"poiid"),d=i.shops[b];d&&o(d,b,c)},".view-map"),a.delegate("click",function(a){a.halt();var b=e.data(this,"id"),c=i.shops[b];c&&p(c)},".search-path"),a.delegate("click",function(a){a.halt();var b=e.data(this,"id"),c=e.data(this,"poiid"),d=i.shops[b];d&&q(d,c)},".correct-poi")}):void E.each(function(a){a.all(".view-map, .search-path, .correct-poi").hide()})}function o(b,c,d){var e,f,j,k="",l=[],m=u(b,c),n=b?b.name:i.name;b&&(k='<a href="javascript:void(0)" class="correct-poi">信息纠错</a>'),n=m.markers.length>1?h.truncateStr(n,16,"..."):n,B=new g({id:H,width:"770px",content:a.Lang.sub(K.getHTML(),{title:n,errorToCorrect:k})}),B.open(),e=a.one("#"+H),f=e.one(".map-container"),B.on("close",function(){f.hide()}),e.delegate("click",function(a){a.halt();var b=i.shops[c];b&&d&&(B.close(),q(b,d))},".correct-poi"),e.delegate("click",function(){window._gaq.push(["_trackEvent","InnerLink","Click","map/view/close"])},".close"),z&&z.destroy(),z=v(e,m),z.render(),z.get("map")&&(1===m.markers.length?z.openInfoWindow(0):(j=e.one(".select-shop"),a.Object.each(i.shops,function(a,b){l.push('<option value="'+b+'">'+a.name+"</option>")}),j.append(l.join("")),j.show(),j.on("change",function(){var b=this.get("value"),c=a.Array.indexOf(A,b);z.openInfoWindow(c)})))}function p(b){var c=null;C=new g({id:I,width:"420px",title:"查询线路",content:a.Lang.sub(L.getHTML(),{shopName:b.name,shopLatLng:b.position.concat().reverse().join()})}),C.open(),c=a.one("#"+I),r(c)}function q(b,c){var d=null;M&&(D=new g({id:J,width:"520px",title:"信息报错",content:a.Lang.sub(M.getHTML(),{shopName:b.name,shopAddress:b.address,shopPhone:b.phone,poiid:c})}),D.open(),d=a.one("#"+J),s(d))}function r(a){var b=a.one("form"),c=a.one(".error"),d=e.field(b,"from");b.on("submit",function(a){return a.halt(),""===d.get("value")?(c.setHTML("请填写您的出发地").setStyle("display","block"),d.focus(),!1):(c.hide(),b.submit(),!0)})}function s(c){function g(){var a=d(k.get("value"));return a&&!k.hasClass("placeholder")||l.get("checked")||n.get("checked")?!1:!0}var h=c.one("form"),i=h.one('input[type="submit"]'),j=c.one("div.correct-group"),k=c.one("#correct-poi-info"),l=c.one("#number-error"),m=c.one(".field-group--error"),n=c.one("#connect-error");a.one("body").on("keydown",function(b){var c=b.keyCode;c===a.mt.macro.key.ESC&&D.close()}),h.delegate("click",function(a){var b=a.target,c=e.data(b,"phoneerror");"true"===c?(j.show(),j.one("input").focus()):j.hide()},'input[name="type"]'),k.plug(a.mt.plugin.Placeholder),h.on("submit",function(a){return a.halt(),g()?void m.show():(m.hide(),f.disableButton(i,!0),void b(h.get("action"),{method:"POST",form:{id:h},on:{success:function(a,b){var c=e.getEvalRes(b);t(c.status?!0:!1)},failure:function(){}}}))})}function t(a){var b,c=2;b=a?{type:"success",title:"提交成功！",tip:"感谢您的报错信息."}:{type:"failure",title:"提交失败",tip:"网络有问题，请稍候重试"},D.showResult(b),D.set("autoHide",c)}function u(b,c){var d=i.shops,e={center:[],defaultZoom:16,markers:[],infoWindows:[]};return b&&(d={},d[c]=b),A=[],a.Object.each(d,function(b,c){var d=[],f=a.Lang.sub(G,{destination:b.position.concat().reverse().join()});d.push('<div class="info-window"><h5>'+b.name+"</h5>"),b.address&&d.push('<p class="detail">'+b.address+"</p>"),b.phone&&d.push('<p class="detail">'+b.phone+"</p>"),d.push('<p><a href="'+f+'" target="_blank" gaevent="map/view/queryroute">公交/驾车路线查询&raquo;</a></p></div>'),e.markers.push({position:b.position,title:b.name}),e.infoWindows.push(d.join("")),A.push(c)}),e}function v(b,c){var d={container:b.one(".map-container"),options:{mapTypeControl:!0,zoomControlOptions:{style:x.ZoomControlStyle.LARGE},panControl:!0,scaleControl:!0}};return a.mix(c,d),new a.mt.Map(c)}var w,x=window.qq&&window.qq.maps;if(i&&x&&(!j||(w=a.one("#map-canvas")))){var y,z,A,B,C,D,E=a.all(".address-list"),F=w&&w.next(".J-view-full"),G="http://map.qq.com/?type=nav&tocoord={destination}&c={destination}&l=13",H="deal-view-map-dialog",I="deal-search-path-dialog",J="correct-poi-dialog",K=a.one("#view-map-markup"),L=a.one("#search-path-markup"),M=a.one("#correct-poi-markup");a.use("mt-map",function(){j&&(l(),m()),E&&n()}),a.Global.on("dealMapMarkers:change",function(b,c){var d=[];y.deleteMarkers(),a.Object.each(b.shops,function(a){d.push({position:a.position,title:a.name})}),y.set("markers",d),y.drawMarkers(),y.set("bounds",y.get("markers")),y.fitBounds(),k(),c&&c()})}},callback:function(){}},a.mt.ComponentHub.attach("soso-map",{ready:function(b){var c=b.component,d=c.params,e=d.callback;return e&&"function"==typeof e?void e():void a.mt.www.Map.showBizMap(d.mapData,d.flag)}})},"1.0.0",{requires:["www-base","mt-dialog"]});
M.add("uix-tabview",function(a){function b(b,c){if(b=a.one(b)){var d={trigger:".tabview__trigger",sheet:".tabview__sheet",activeClass:"current"};c=a.mix(c||{},d),b.delegate("click",function(){var d=b.all(c.trigger),e=b.all(c.sheet);if(d.size()&&d.size()===e.size()){var f=d.indexOf(this);d.removeClass(c.activeClass),d.item(f).addClass(c.activeClass),e.hide(),e.item(f).show(),6===a.UA.ie&&a.mt.util.reflow()}},c.trigger)}}a.namespace("mt.uix"),a.mt.uix.Tabview=b},"1.0.0",{requires:["mt-base","node"]});
M.add("holy-reco",function(a){a.mt.ComponentHub.attach("holy-reco",function(){a.mt.uix.Tabview(this,{trigger:".J-holy-reco__label",sheet:".J-holy-reco__content"})})},"1.0.0",{requires:["www-base","uix-tabview"]});
M.add("rightbottom-sticky",function(a){var b=a.mt.www,c=a.mt.util,d=a.mt.Dialog,e=a.io;b.RightbottomSticky={init:function(d){function e(b,c){b&&(c=c||{},a.mix(c,{mainAreaWidth:980,bottomEdge:".site-info-w",bottomOffset:20}),a.use("uix-sticky",function(a){new a.mt.uix.Sticky(b,{canDisappear:!0,mainAreaWidth:c.mainAreaWidth,bottomEdge:c.bottomEdge,hAlign:"right",vAlign:"bottom",vBottomOffset:c.bottomOffset})}))}function f(b){var c=j.one("#fixbar-item-top");c&&(b=b||{},a.mix(b,{maxAreaWidth:980,bottomEdge:".site-info-w",content:"",minScrollTop:140,bottomOffset:20}),a.use("uix-smoothscroll","uix-sticky",function(a){a.mt.uix.Smoothscroll(c,{trigger:".J-go-top"}),new a.mt.uix.Sticky(c,{canDisappear:!0,mainAreaWidth:b.mainAreaWidth,bottomEdge:b.bottomEdge,hAlign:"right",vAlign:"bottom",vMinScrollTop:b.minScrollTop,vBottomOffset:b.bottomOffset})}))}function g(b){var c=j.one("#fixbar-item-vote");if(c){if(b=b||{},b.hide)return void c.hide();a.mix(b,{maxAreaWidth:980,bottomOffset:20,minScrollTop:0,bottomEdge:".site-info-w",ga:"",url:"/survey/82"}),a.use("uix-sticky",function(a){new a.mt.uix.Sticky(c,{canDisappear:!0,mainAreaWidth:b.mainAreaWidth,bottomEdge:b.bottomEdge,hAlign:"right",vAlign:"bottom",vMinScrollTop:b.minScrollTop,vBottomOffset:b.bottomOffset})})}}function h(c){var d,e=j.one("#fixbar-item-help");if(e){if(c=c||{},c.hide)return void e.hide();a.mix(c,{mainAreaWidth:980,bottomOffset:20,minScrollTop:0,bottomEdge:".site-info-w"}),a.use("uix-sticky",function(a){new a.mt.uix.Sticky(j,{canDisappear:!0,mainAreaWidth:c.mainAreaWidth,bottomEdge:c.bottomEdge,hAlign:"right",vAlign:"bottom",vMinScrollTop:c.minScrollTop,vBottomOffset:c.bottomOffset})}),a.one(document.body).delegate("click",function(a){a.preventDefault(),d?d.open():d=b.RightbottomSticky.help()},".J-lift-help")}}function i(b){var c,d=j.one("#fixbar-item-feedback");if(d){if(b=b||{},b.hide)return void d.hide();a.mix(b,{mainAreaWidth:980,bottomOffset:20,minScrollTop:0,ga:"",bottomEdge:".site-info-w"}),b.url&&(b.ga&&(b.ga='gaevent="'+b.ga+'"'),c='<a target="_blank" class="new-index-triffle lift-nav lift-nav--feedback" hidefocus="true"'+b.ga+' href="'+b.url+'"><i></i><span>意见反馈</span></a>',d.setHTML(c),a.use("uix-sticky",function(a){new a.mt.uix.Sticky(d,{canDisappear:!0,mainAreaWidth:b.mainAreaWidth,bottomEdge:b.bottomEdge,hAlign:"right",vAlign:"bottom",vMinScrollTop:b.minScrollTop,vBottomOffset:b.bottomOffset})}))}}var j,k;if(j=d.component.node,j&&(k=j.one("#fixbar-container"))){var l=c.decodeJSON(k.getData("config"))||{};a.mix(l,{topConfig:{},voteConfig:{},helpConfig:{},feedbackConfig:{},containerConfig:{}}),e(k,l.containerConfig),f(l.topConfig),g(l.voteConfig),h(l.helpConfig),i(l.feedbackConfig)}},help:function(){var b,f,g="help-center-dialog";return b=new d({id:g,title:"帮助中心",width:"681px",content:'<div class="loading-jump--large" style="height:365px;"></div>'}),b.open(),f=a.one("#"+g),e("/help/center",{method:"POST",on:{success:function(a,d){var e=c.getEvalRes(d);b.set("content",e.content),f.one(".body").setStyle("height","365px"),b.set("centered",!0)}}}),b}},a.mt.ComponentHub.attach("rightbottom-sticky",function(a){b.RightbottomSticky.init(a)})},"1.0.0",{requires:["mt-base","mt-dialog"]});